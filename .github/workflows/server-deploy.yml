name: Deploy Server

on:
  push:
    paths:
      - 'server/**'
      - '.github/workflows/server-deploy.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: prod
    env:
      DEPLOY_HOST: ${{ vars.DEPLOY_HOST }}
      DEPLOY_USER: ${{ vars.DEPLOY_USER }}
      DEPLOY_PORT: ${{ vars.DEPLOY_PORT || 22 }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        working-directory: ./server
        run: pnpm install --no-frozen-lockfile

      - name: Build server
        working-directory: ./server
        run: pnpm run build

      - name: Deploy to temporary location
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.DEPLOY_HOST }}
          username: ${{ env.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ env.DEPLOY_PORT }}
          source: "server/dist,server/package.json,server/pnpm-lock.yaml,server/opentelemetry-proto"
          target: "/opt/aiqa/server.new"
          strip_components: 1

      - name: Verify deployment and swap files
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.DEPLOY_HOST }}
          username: ${{ env.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ env.DEPLOY_PORT }}
          script: |
            # Verify new deployment files exist
            if [ ! -f /opt/aiqa/server.new/dist/index.js ]; then
              echo "ERROR: New deployment missing dist/index.js!"
              sudo rm -rf /opt/aiqa/server.new
              exit 1
            fi
            
            # Stop service before swapping files (minimal downtime)
            sudo systemctl stop aiqa-server || true
            
            # Backup old files (for rollback)
            if [ -d /opt/aiqa/server/dist ]; then
              sudo mv /opt/aiqa/server/dist /opt/aiqa/server/dist.old || true
            fi
            if [ -f /opt/aiqa/server/package.json ]; then
              sudo mv /opt/aiqa/server/package.json /opt/aiqa/server/package.json.old || true
            fi
            if [ -f /opt/aiqa/server/pnpm-lock.yaml ]; then
              sudo mv /opt/aiqa/server/pnpm-lock.yaml /opt/aiqa/server/pnpm-lock.yaml.old || true
            fi
            
            # Move new files into place
            sudo mv /opt/aiqa/server.new/dist /opt/aiqa/server/dist
            sudo mv /opt/aiqa/server.new/package.json /opt/aiqa/server/package.json
            sudo mv /opt/aiqa/server.new/pnpm-lock.yaml /opt/aiqa/server/pnpm-lock.yaml
            # Move opentelemetry-proto directory if it exists
            if [ -d /opt/aiqa/server.new/opentelemetry-proto ]; then
              sudo rm -rf /opt/aiqa/server/opentelemetry-proto || true
              sudo mv /opt/aiqa/server.new/opentelemetry-proto /opt/aiqa/server/opentelemetry-proto
            fi
            
            # Clean up temp directory
            sudo rmdir /opt/aiqa/server.new || sudo rm -rf /opt/aiqa/server.new
            
            # Clean up old backup (keep last deployment for rollback)
            sudo rm -rf /opt/aiqa/server/dist.old.old || true
            if [ -d /opt/aiqa/server/dist.old ]; then
              sudo mv /opt/aiqa/server/dist.old /opt/aiqa/server/dist.old.old || true
            fi
            sudo rm -f /opt/aiqa/server/package.json.old /opt/aiqa/server/pnpm-lock.yaml.old || true

      - name: Install dependencies and configure server
        uses: appleboy/ssh-action@v1.0.3
        env:
          SERVER_PORT: ${{ vars.SERVER_PORT || '4318' }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          PGHOST: ${{ secrets.PGHOST }}
          PGDATABASE: ${{ secrets.PGDATABASE }}
          PGUSER: ${{ secrets.PGUSER }}
          PGPASSWORD: ${{ secrets.PGPASSWORD }}
          PGSSLMODE: ${{ vars.PGSSLMODE || 'require' }}
          PGCHANNELBINDING: ${{ vars.PGCHANNELBINDING || 'require' }}
          AZURE_OPENAI_ENDPOINT: ${{ vars.AZURE_OPENAI_ENDPOINT }}
          ELASTICSEARCH_URL: ${{ vars.ELASTICSEARCH_URL || 'http://localhost:9200' }}
          SPANS_INDEX: ${{ vars.SPANS_INDEX || 'aiqa_spans' }}
          SPANS_INDEX_ALIAS: ${{ vars.SPANS_INDEX_ALIAS || 'aiqa_spans_alias' }}
          DATASET_EXAMPLES_INDEX: ${{ vars.DATASET_EXAMPLES_INDEX || 'aiqa_dataset_examples' }}
          DATASET_EXAMPLES_INDEX_ALIAS: ${{ vars.DATASET_EXAMPLES_INDEX_ALIAS || 'aiqa_dataset_examples_alias' }}
          AUTH0_DOMAIN: ${{ vars.AUTH0_DOMAIN }}
          AUTH0_AUDIENCE: ${{ vars.AUTH0_AUDIENCE }}
        with:
          host: ${{ env.DEPLOY_HOST }}
          username: ${{ env.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ env.DEPLOY_PORT }}
          envs: SERVER_PORT,DATABASE_URL,PGHOST,PGDATABASE,PGUSER,PGPASSWORD,PGSSLMODE,PGCHANNELBINDING,ELASTICSEARCH_URL,SPANS_INDEX,SPANS_INDEX_ALIAS,DATASET_EXAMPLES_INDEX,DATASET_EXAMPLES_INDEX_ALIAS,AUTH0_DOMAIN,AUTH0_AUDIENCE,AZURE_OPENAI_ENDPOINT
          script: |
            cd /opt/aiqa/server
            # Ensure directory is writable by deployment user
            sudo chown -R $USER:$USER /opt/aiqa/server || true
            # Ensure pnpm is available
            if ! command -v pnpm &> /dev/null; then
              echo "pnpm not found, installing..."
              npm install -g pnpm
            fi
            # Install dependencies (as deployment user)
            echo "Installing production dependencies..."
            pnpm install --prod --no-frozen-lockfile
            # Verify critical dependencies are installed
            if [ ! -d node_modules/fastify ]; then
              echo "ERROR: fastify module not found after installation!"
              echo "Retrying dependency installation..."
              rm -rf node_modules
              pnpm install --prod --no-frozen-lockfile
              if [ ! -d node_modules/fastify ]; then
                echo "ERROR: Failed to install dependencies after retry!"
                exit 1
              fi
            fi
            echo "Dependencies installed successfully"
            # Create .env file
            {
              echo "ENVIRONMENT=production"
              echo "PORT=${SERVER_PORT:-4318}"
              [ -n "${DATABASE_URL}" ] && echo "DATABASE_URL=${DATABASE_URL}"
              echo "PGHOST=${PGHOST}"
              echo "PGDATABASE=${PGDATABASE}"
              echo "PGUSER=${PGUSER}"
              echo "PGPASSWORD=${PGPASSWORD}"
              echo "PGSSLMODE=${PGSSLMODE:-require}"
              echo "PGCHANNELBINDING=${PGCHANNELBINDING:-require}"
              echo "ELASTICSEARCH_URL=${ELASTICSEARCH_URL:-http://localhost:9200}"
              echo "SPANS_INDEX=${SPANS_INDEX:-aiqa_spans}"
              echo "SPANS_INDEX_ALIAS=${SPANS_INDEX_ALIAS:-aiqa_spans_alias}"
              echo "DATASET_EXAMPLES_INDEX=${DATASET_EXAMPLES_INDEX:-aiqa_dataset_examples}"
              echo "DATASET_EXAMPLES_INDEX_ALIAS=${DATASET_EXAMPLES_INDEX_ALIAS:-aiqa_dataset_examples_alias}"
              echo "AUTH0_DOMAIN=${AUTH0_DOMAIN}"
              echo "AUTH0_AUDIENCE=${AUTH0_AUDIENCE}"
              [ -n "${AZURE_OPENAI_ENDPOINT}" ] && echo "AZURE_OPENAI_ENDPOINT=${AZURE_OPENAI_ENDPOINT}"
            } > .env
            # Set all permissions to winterwell
            sudo chown -R winterwell:winterwell /opt/aiqa/server
            sudo chmod 600 .env
            # Verify dist/index.js exists
            if [ ! -f dist/index.js ]; then
              echo "ERROR: dist/index.js not found!"
              exit 1
            fi
            # Verify node_modules exists and contains critical dependencies
            if [ ! -d node_modules ] || [ ! -d node_modules/fastify ]; then
              echo "ERROR: node_modules missing or incomplete!"
              exit 1
            fi
            # Verify opentelemetry-proto directory exists (required for gRPC support)
            if [ ! -d opentelemetry-proto ]; then
              echo "WARNING: opentelemetry-proto directory not found. gRPC support will not be available."
              echo "OTLP/HTTP (JSON and Protobuf) will still work."
            elif [ ! -f opentelemetry-proto/opentelemetry/proto/collector/trace/v1/trace_service.proto ]; then
              echo "WARNING: trace_service.proto not found. gRPC support will not be available."
            fi
            # Reload systemd and restart service
            sudo systemctl daemon-reload
            sudo systemctl restart aiqa-server
            sleep 2
            sudo systemctl status aiqa-server --no-pager -l

