# Nginx configuration for server-side SSL termination
# This file is meant to be used on your host server's nginx (not the docker nginx)
# It handles SSL termination and forwards traffic to the AIQA docker containers
#
# Architecture:
# - Nginx listens on ports 80, 443, 4318, 4317 (public-facing HTTPS)
# - Docker containers expose ports 4000, 4418, 4417 (internal)
# - Nginx proxies: 443 -> 4000, 4318 -> 4418, 4317 -> 4417
#
# Setup:
# 1. Replace 'yourserver.yourdomain.com' with your actual domain.
# You can do that from the command line with: sed -i 's/yourserver.yourdomain.com/actualvalue/g' nginx.example.yourserver.conf
# 2. Ensure Let's Encrypt certificates are in /etc/letsencrypt/live/yourserver.yourdomain.com/
# 3. Ensure /var/www/letsencrypt exists for ACME challenges
# 4. Place this file in /etc/nginx/sites-available/ and symlink to /etc/nginx/sites-enabled/
# 5. Run: sudo nginx -t && sudo systemctl reload nginx
#
# Docker containers expose:
# - Port 4000: Webapp (nginx container) - accessed via nginx port 443
# - Port 4418: Server HTTP API - accessed via nginx port 4318
# - Port 4417: Server gRPC - accessed via nginx port 4317

server {
  listen 80;
  #server_name langx.duckdns.org;
  server_name yourserver.yourdomain.com;

  # Let's Encrypt challenge location (must come before redirect)
  location ^~ /.well-known/acme-challenge/ {
    root /var/www/letsencrypt;
    default_type "text/plain";
  }

  # Redirect all other HTTP traffic to HTTPS
  location / {
    return 301 https://$server_name$request_uri;
  }
}

server {
  listen 443 ssl;
  server_name yourserver.yourdomain.com;

  ssl_certificate     /etc/letsencrypt/live/yourserver.yourdomain.com/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/yourserver.yourdomain.com/privkey.pem;

  ssl_protocols TLSv1.2 TLSv1.3;

  location / {
    proxy_pass http://127.0.0.1:4000;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Real-IP $remote_addr;
  }
}

# Server HTTP API - nginx listens on 4318 (public HTTPS) and proxies to Docker on 4418
server {
  listen 4318 ssl;
  server_name yourserver.yourdomain.com;

  ssl_certificate     /etc/letsencrypt/live/yourserver.yourdomain.com/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/yourserver.yourdomain.com/privkey.pem;

  ssl_protocols TLSv1.2 TLSv1.3;

  location / {
    proxy_pass http://127.0.0.1:4418;  # Forward to Docker's exposed port
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Real-IP $remote_addr;
  }
}

# Server gRPC - nginx listens on 4317 (public HTTPS) and proxies to Docker on 4417
server {
  listen 4317 ssl;
  server_name yourserver.yourdomain.com;

  ssl_certificate     /etc/letsencrypt/live/yourserver.yourdomain.com/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/yourserver.yourdomain.com/privkey.pem;

  ssl_protocols TLSv1.2 TLSv1.3;

  location / {
    proxy_pass http://127.0.0.1:4417;  # Forward to Docker's exposed port
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Real-IP $remote_addr;
  }
}